name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  PYTHON_VERSION: "3.11"
  NODE_VERSION: "20"

jobs:
  # ============================================================
  # Backend Tests
  # ============================================================
  backend-smoke:
    name: Backend Smoke (Golden Paths)
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: strideiq_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: apps/api/requirements.txt

      - name: Install dependencies
        working-directory: apps/api
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run smoke tests
        working-directory: apps/api
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/strideiq_test
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY: test-secret-key-for-ci
          DEBUG: "false"
          RATE_LIMIT_ENABLED: "false"
          # Phase 7/8: provider import tests write to UPLOADS_DIR.
          # Use a writable temp directory in GitHub Actions.
          UPLOADS_DIR: /tmp/uploads
        run: |
          pytest -q \
            tests/test_phase3_onboarding_golden_path_simulated.py \
            tests/test_phase5_rate_limit_deferral.py \
            tests/test_admin_actions_onboarding_ingestion_block.py \
            tests/test_phase7_garmin_file_import_e2e.py \
            tests/test_phase8_security_golden_paths.py \
            tests/test_phase8_impersonation_high_risk_blocks.py \
            tests/test_phase8_token_jwt_invariants.py \
            tests/test_phase9_backend_smoke_golden_paths.py

  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: strideiq_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: apps/api/requirements.txt
      
      - name: Install dependencies
        working-directory: apps/api
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Run tests with coverage
        working-directory: apps/api
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/strideiq_test
          REDIS_URL: redis://localhost:6379/0
          SECRET_KEY: test-secret-key-for-ci
          DEBUG: "false"
          RATE_LIMIT_ENABLED: "false"
        run: |
          pytest -v --cov=. --cov-report=xml --cov-report=term-missing
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: apps/api/coverage.xml
          flags: backend
          fail_ci_if_error: false

  # ============================================================
  # Backend Linting
  # ============================================================
  backend-lint:
    name: Backend Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install linters
        run: pip install ruff black
      
      - name: Run Ruff (linting)
        working-directory: apps/api
        run: ruff check . --output-format=github
        continue-on-error: true  # Don't fail CI on lint warnings yet
      
      - name: Run Black (formatting check)
        working-directory: apps/api
        run: black --check --diff .
        continue-on-error: true  # Don't fail CI on formatting yet

  # ============================================================
  # Frontend Build & Lint
  # ============================================================
  frontend-test:
    name: Frontend Tests (Jest)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json

      - name: Install dependencies
        working-directory: apps/web
        run: npm ci

      - name: Run Jest smoke suite
        working-directory: apps/web
        env:
          CI: "true"
        run: |
          npm test --silent -- \
            admin-access-guard.test.tsx \
            admin-ops-visibility.test.tsx \
            home-latency-bridge.test.tsx \
            home-latency-bridge-queued.test.tsx \
            home-ingestion-paused-banner.test.tsx \
            coach-scroll-layout.test.tsx \
            landing-cta-register.test.tsx \
            onboarding-connect-import-status.test.tsx \
            settings-trial-membership.test.tsx \
            plans-model-driven.test.tsx \
            plan-create-gating.test.tsx \
            subscriber-value-deep-dive.test.tsx

  frontend-build:
    name: Frontend Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: apps/web/package-lock.json
      
      - name: Install dependencies
        working-directory: apps/web
        run: npm ci
      
      - name: Run ESLint
        working-directory: apps/web
        run: npm run lint
      
      - name: TypeScript type check
        working-directory: apps/web
        run: npx tsc --noEmit
      
      - name: Build
        working-directory: apps/web
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000
        run: npm run build

  # ============================================================
  # Security Scan
  # ============================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install safety
        run: pip install safety pip-audit

      - name: Quick secret literal scan (fail on obvious leaks)
        run: |
          python - <<'PY'
          from __future__ import annotations
          from pathlib import Path
          import re
          import sys

          # High-signal patterns that should never be committed.
          forbidden_regexes = [
            # API keys (common high-risk formats)
            re.compile(r"sk-[A-Za-z0-9_-]{20,}"),                 # OpenAI-style keys
            re.compile(r"sk_(?:live|test)_[A-Za-z0-9]{16,}"),     # Stripe secret keys
            re.compile(r"rk_(?:live|test)_[A-Za-z0-9]{16,}"),     # Stripe restricted keys
            re.compile(r"whsec_[A-Za-z0-9]{16,}"),                # Stripe webhook signing secret
            re.compile(r"ghp_[A-Za-z0-9]{30,}"),                  # GitHub classic PAT
            re.compile(r"github_pat_[A-Za-z0-9_]{30,}"),          # GitHub fine-grained PAT
            re.compile(r"AIza[0-9A-Za-z\-_]{35}"),                # Google API key
            re.compile(r"-----BEGIN (?:RSA )?PRIVATE KEY-----"),
            re.compile(r"AWS_SECRET_ACCESS_KEY\\s*="),
            re.compile(r"OPENAI_API_KEY\\s*="),
            # Only flag literal assignments (avoid false positives from env lookups).
            re.compile(r"STRAVA_CLIENT_SECRET\\s*=\\s*['\\\"][^'\\\"]{8,}['\\\"]"),
            re.compile(r"GARMIN_CLIENT_SECRET\\s*=\\s*['\\\"][^'\\\"]{8,}['\\\"]"),
            re.compile(r"SECRET_KEY\\s*=\\s*['\\\"][^'\\\"]{8,}['\\\"]"),  # app JWT signing secret
            # Prevent “helpful” hardcoded E2E fallbacks.
            re.compile(r"process\\.env\\.E2E_PASSWORD\\s*\\|\\|\\s*['\\\"]"),
            re.compile(r"process\\.env\\.E2E_EMAIL\\s*\\|\\|\\s*['\\\"]"),

            # JWT / bearer tokens (very high-signal; avoids generic “Bearer .*” false positives)
            re.compile(r"Authorization\\s*:\\s*Bearer\\s+eyJ[A-Za-z0-9_-]+\\.[A-Za-z0-9_-]+\\.[A-Za-z0-9_-]+"),
            re.compile(r"\\beyJ[A-Za-z0-9_-]+\\.[A-Za-z0-9_-]+\\.[A-Za-z0-9_-]+\\b"),
          ]

          # Self-test: ensure our regexes actually catch known dummy strings (no repo files involved).
          # This prevents accidental weakening of patterns over time.
          canaries = [
            "sk_test_1234567890abcdefghijklmnopqrstuvwxyz",
            "whsec_1234567890abcdefghijklmnopqrstuvwxyz",
            "ghp_1234567890abcdefghijklmnopqrstuvwxyz1234567890",
            "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NSJ9.signature",
          ]
          for c in canaries:
            if not any(rx.search(c) for rx in forbidden_regexes):
              print(f"Secret scan self-test FAILED to match canary: {c!r}")
              sys.exit(1)

          offenders: list[str] = []
          root = Path(".")
          # Limit scan scope to runtime code + scripts (avoid docs/history noise).
          scan_roots = [root / "apps", root / "scripts"]
          for base in scan_roots:
            if not base.exists():
              continue
            for p in base.rglob("*"):
              if not p.is_file():
                continue
              # Skip common binary/build directories.
              if any(
                part in p.parts
                for part in (".git", "node_modules", ".next", "dist", "build", "__pycache__", "venv", ".venv", "__pypackages__")
              ):
                continue
              try:
                data = p.read_bytes()
              except Exception:
                continue
              # Skip likely binary files.
              if b"\x00" in data:
                continue
              try:
                text = data.decode("utf-8", errors="ignore")
              except Exception:
                continue

              for rx in forbidden_regexes:
                if rx.search(text):
                  offenders.append(f"{p}: matches forbidden pattern: {rx.pattern}")

          if offenders:
            print("Forbidden secrets/PII found:")
            print("\n".join(offenders[:80]))
            sys.exit(1)
          print("Secret scan: OK")
          PY

      - name: Secret config presence check (templates)
        run: |
          python - <<'PY'
          from __future__ import annotations

          from pathlib import Path
          import sys

          # Ensure our config templates mention the required secret *names*.
          # This prevents accidentally removing env vars from deployment templates.
          # NOTE: This does NOT validate values.
          required_groups: list[tuple[str, ...]] = [
              ("SECRET_KEY", "JWT_SECRET_KEY"),  # repo uses SECRET_KEY; allow legacy alias
              ("TOKEN_ENCRYPTION_KEY",),
              ("POSTGRES_PASSWORD",),
              ("STRAVA_CLIENT_SECRET",),
              ("STRAVA_WEBHOOK_VERIFY_TOKEN",),
              ("GARMIN_CLIENT_SECRET",),
              ("STRIPE_SECRET_KEY",),
              ("STRIPE_WEBHOOK_SECRET",),
          ]

          candidate_files: list[Path] = []
          for rel in ("docker-compose.yml", ".env.example"):
              p = Path(rel)
              if p.exists():
                  candidate_files.append(p)

          # Optional deployment/config directories if they exist.
          for d in ("deploy", "deployment", "k8s", "helm", "infra"):
              base = Path(d)
              if not base.exists():
                  continue
              for p in base.rglob("*"):
                  if p.is_file() and p.suffix.lower() in (".yml", ".yaml", ".env", ".tmpl", ".template"):
                      candidate_files.append(p)

          # De-dupe while preserving order.
          seen: set[str] = set()
          files = []
          for p in candidate_files:
              s = str(p)
              if s not in seen:
                  seen.add(s)
                  files.append(p)

          if not files:
              print("Secret config presence check FAILED: no template/config files found to scan.")
              sys.exit(1)

          corpus = "\n".join(p.read_text(encoding="utf-8", errors="ignore") for p in files)

          missing: list[str] = []
          for group in required_groups:
              if not any(name in corpus for name in group):
                  missing.append(" or ".join(group))

          if missing:
              print("Secret config presence check FAILED. Missing required secret names in templates:")
              for m in missing:
                  print(f"- {m}")
              print("\nScanned files:")
              for p in files:
                  print(f"- {p}")
              sys.exit(1)

          print("Secret config presence check: OK")
          print("Scanned files:")
          for p in files:
              print(f"- {p}")
          PY
      
      - name: Check Python dependencies for vulnerabilities
        working-directory: apps/api
        run: pip-audit -r requirements.txt
        continue-on-error: true  # Report but don't block

  # ============================================================
  # Docker Build Test
  # ============================================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build API image
        uses: docker/build-push-action@v5
        with:
          context: apps/api
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build Web image
        uses: docker/build-push-action@v5
        with:
          context: apps/web
          push: false
          cache-from: type=gha
          cache-to: type=gha,mode=max
